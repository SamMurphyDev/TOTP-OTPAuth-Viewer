<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TOTP Code Generator (Auto-Refresh)</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/otpauth@9.4.1/dist/otpauth.umd.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <style>
      #totpCode {
        font-size: 3.5rem;
        font-weight: 700;
        letter-spacing: 0.1em;
      }
      .container {
        max-width: 600px;
      }
      #progressContainer {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
      }
      #progressBar {
        width: 100%;
        height: 100%;
        background-color: var(--bs-primary);
        transition: none;
        transform-origin: left;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">ðŸ”‘ TOTP Code Generator</h3>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <label for="otpauthString" class="form-label"
              >OTPAuth Protocol String:</label
            >
            <input
              type="text"
              class="form-control"
              id="otpauthString"
              placeholder="e.g., otpauth://totp/Example:user?secret=JBSWY3DPEHPK3PXP&issuer=Example&period=60"
            />
            <div class="form-text">
              Paste your `otpauth://` string here (must be TOTP type).
            </div>
          </div>

          <div class="text-center mb-4 p-3 bg-light border rounded">
            <p class="text-muted mb-1">Generated TOTP Code</p>
            <div id="totpCode" class="text-success mb-2">_ _ _ _ _ _</div>

            <div id="progressContainer">
              <div id="progressBar"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const { TOTP } = OTPAuth;
      const inputElement = document.getElementById('otpauthString');
      const codeElement = document.getElementById('totpCode');
      const generateButton = document.getElementById('generateBtn');
      const clearButton = document.getElementById('clearBtn');
      const progressBar = document.getElementById('progressBar');

      let otpTimer;
      let countdownInterval;

      /**
       * Clears all running timers (timeout for refresh and interval for progress bar).
       */
      function clearTimers() {
        if (otpTimer) clearTimeout(otpTimer);
        if (countdownInterval) clearInterval(countdownInterval);
      }

      /**
       * Updates the visual progress bar based on time remaining.
       * @param {number} secondsElapsed - The number of seconds passed in the current period.
       * @param {number} period - The TOTP period in seconds (default 30).
       */
      function updateProgressBar(secondsElapsed, period) {
        const timeRemaining = period - secondsElapsed;
        const percentage = (timeRemaining / period) * 100;

        // Set the width for the countdown effect (100% down to 0%)
        progressBar.style.transform = `scaleX(${percentage / 100})`;
      }

      /**
       * Parses the otpauth string, generates the TOTP code, and sets up auto-refresh.
       */
      function generateTotpCode() {
        clearTimers(); // Stop previous timers

        const otpauthString = inputElement.value.trim();
        const defaultPeriod = 30; // Default period if not specified

        if (!otpauthString) {
          codeElement.textContent = 'Enter String';
          codeElement.classList.add('text-danger');
          codeElement.classList.remove('text-success');
          progressBar.style.transform = 'scaleX(0)'; // Reset bar
          return;
        }

        try {
          // 1. Create a TOTP object from the otpauth string
          const totp = OTPAuth.URI.parse(otpauthString);

          // Get the period, defaulting to 30 seconds if not specified in the URL
          const period = totp.period ?? defaultPeriod;

          // 2. Generate the token
          const token = totp.generate();

          // 3. Display the token
          codeElement.textContent = token.replace(/(\d{3})(\d{3})/, '$1 $2'); // Add space for readability
          codeElement.classList.remove('text-danger');
          codeElement.classList.add('text-success');

          // 4. Calculate the time until the next code (for auto-refresh)
          const epoch = Math.floor(Date.now() / 1000);
          const secondsElapsed = epoch % period;
          const timeToNextCode = (period - secondsElapsed) * 1000 + 100; // Add 100ms buffer

          // 5. Set the next code refresh timer
          otpTimer = setTimeout(generateTotpCode, timeToNextCode);

          // 6. Start the visual countdown interval
          let elapsed = secondsElapsed;
          updateProgressBar(elapsed, period); // Initial bar state

          countdownInterval = setInterval(() => {
            elapsed = (elapsed + 1) % period; // Increment elapsed seconds, wrapping at 'period'
            updateProgressBar(elapsed, period);

            if (elapsed === 0) {
              // This technically happens 1 second before the code regenerates,
              // but it ensures the bar is fully reset just before the new code appears.
              clearInterval(countdownInterval);
            }
          }, 1000);
        } catch (error) {
          codeElement.textContent = 'Invalid String';
          codeElement.classList.add('text-danger');
          codeElement.classList.remove('text-success');
          progressBar.style.transform = 'scaleX(0)'; // Reset bar
          console.error('Error parsing or generating code:', error.message);
        }
      }

      /**
       * Clears the input and resets the display.
       */
      function clearFields() {
        clearTimers();
        inputElement.value = '';
        codeElement.textContent = '_ _ _ _ _ _';
        codeElement.classList.remove('text-danger');
        codeElement.classList.add('text-success');
        progressBar.style.transform = 'scaleX(0)'; // Reset bar
      }

      inputElement.addEventListener('keyup', generateTotpCode);
    </script>
  </body>
</html>
